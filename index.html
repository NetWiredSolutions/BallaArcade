// Uses global THREE and THREE.PointerLockControls from script tags in index.html

let camera, scene, renderer;
let controls;

let moveForward = false;
let moveBackward = false;
let moveLeft = false;
let moveRight = false;
let isSprinting = false;
let canJump = false;

let velocity = new THREE.Vector3();
let direction = new THREE.Vector3();
let prevTime = performance.now();

const objects = [];
const enemies = [];

let health = 100;
let kills = 0;

let lastDamageTime = 0;
const REGEN_DELAY = 3;
const REGEN_RATE = 15;

const MAG_SIZE = 30;
let ammoInMag = MAG_SIZE;
let reserveAmmo = 120;
let isReloading = false;
const RELOAD_TIME = 1.5;

const menuOverlay = document.getElementById('menuOverlay');
const playButton = document.getElementById('playButton');
const pauseOverlay = document.getElementById('pauseOverlay');

const healthEl = document.getElementById('health');
const ammoEl = document.getElementById('ammo');
const reserveAmmoEl = document.getElementById('reserveAmmo');
const killsEl = document.getElementById('kills');
const reloadHintEl = document.getElementById('reloadHint');
const hitmarkerEl = document.getElementById('hitmarker');
const killfeedEl = document.getElementById('killfeed');

let gameStarted = false;
let gunGroup;

init();
animate();

function init() {
  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(window.devicePixelRatio);
  document.body.appendChild(renderer.domElement);

  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x050505);
  scene.fog = new THREE.Fog(0x050505, 10, 250);

  camera = new THREE.PerspectiveCamera(
    75,
    window.innerWidth / window.innerHeight,
    0.1,
    1000
  );

  const hemiLight = new THREE.HemisphereLight(0xffffff, 0x222222, 0.6);
  hemiLight.position.set(0, 200, 0);
  scene.add(hemiLight);

  const dirLight = new THREE.DirectionalLight(0xffffff, 0.9);
  dirLight.position.set(30, 50, -30);
  scene.add(dirLight);

  controls = new THREE.PointerLockControls(camera, document.body);
  controls.getObject().position.set(0, 5, 0);
  scene.add(controls.getObject());

  playButton.addEventListener('click', () => {
    startGame();
  });

  controls.addEventListener('lock', () => {
    pauseOverlay.style.display = 'none';
  });

  controls.addEventListener('unlock', () => {
    if (gameStarted) {
      pauseOverlay.style.display = 'flex';
    }
  });

  const floorGeo = new THREE.PlaneGeometry(400, 400);
  const floorMat = new THREE.MeshPhongMaterial({ color: 0x202020, depthWrite: true });
  const floor = new THREE.Mesh(floorGeo, floorMat);
  floor.rotation.x = -Math.PI / 2;
  floor.receiveShadow = true;
  scene.add(floor);

  createMap();
  spawnEnemies(18);
  createGunModel();

  document.addEventListener('keydown', onKeyDown);
  document.addEventListener('keyup', onKeyUp);

  document.addEventListener('mousedown', (e) => {
    if (!gameStarted) return;
    if (controls.isLocked && e.button === 0) {
      handleShoot();
    } else if (gameStarted && !controls.isLocked) {
      controls.lock();
    }
  });

  pauseOverlay.addEventListener('click', () => {
    if (!controls.isLocked && gameStarted) {
      controls.lock();
    }
  });

  window.addEventListener('resize', onWindowResize);

  updateHUD();
}

function startGame() {
  menuOverlay.style.display = 'none';
  gameStarted = true;
  controls.lock();
}

function createMap() {
  const wallMat = new THREE.MeshPhongMaterial({ color: 0x404040 });
  const buildingMat = new THREE.MeshPhongMaterial({ color: 0x262626 });
  const crateMat = new THREE.MeshPhongMaterial({ color: 0x353535 });

  const wallGeoLong = new THREE.BoxGeometry(400, 12, 2);
  const wallGeoShort = new THREE.BoxGeometry(2, 12, 400);

  const wall1 = new THREE.Mesh(wallGeoLong, wallMat);
  wall1.position.set(0, 6, -200);
  scene.add(wall1);
  objects.push(wall1);

  const wall2 = wall
